workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always
    - when: never
      

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  CUSTOM_CI_BUILDS_DIR: "/usr/workspace/$$USER/gitlab-runner-builds"
  CUSTOM_CI_ENV_DIR: "/usr/workspace/$$USER/gitlab-runner-envs"
  CUSTOM_CI_OUTPUR_DIR: "/usr/workspace/$$USER/gitlab-runner-outputs"
  # Reposiroty information
  DLIO_BENCHMARK_REPO: https://github.com/argonne-lcf/dlio_benchmark.git
  DLIO_BENCHMARK_TAG: feature/optional-dftracer
  # test variable
  ENV_NAME: dlio_env_2

.lc:
  id_tokens:
    SITE_ID_TOKEN:
      aud: https://lc.llnl.gov/gitlab

.corona:
  extends: .lc
  tags:
    - shell
    - corona
  variables:
    PYTHON_MODULE: python/3.9.12
    MPI_MODULE: openmpi/4.1.2
    GCC_MODULE: gcc/10.3.1
    DATA_PATH: "/p/lustre3/$$USER/gitlab-runner-data/"
    LOG_STORE_DIR: "/p/lustre3/iopp/dftracer-traces-lfs"
    CORES: 48
    GPUS: 8
    NODES: 1
    WALLTIME: 60
    QUEUE: pdebug

.dlio_test_script:
  script:
    - source .gitlab/scripts/variables.sh
    - source .gitlab/scripts/pre.sh
    - source .gitlab/scripts/build.sh
    - source .gitlab/scripts/dlio_benchmark_test.sh
    - source .gitlab/scripts/post.sh

dlio_test_corona:
  extends:
    - .corona
    - .dlio_test_script